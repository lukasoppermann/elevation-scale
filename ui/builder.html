<style>
  .hidden {
    display: none;
  }
</style>
<header>
  <h2>Rectangle Creator</h2>
  <div class="info">You can use a <span class="text-highlight">#</span> for the number on the scale (1, 2, 3).</div>
</header>
<main>
  <!-- empty State -->
  <section data-section="emptyState">
    <p>Select an elevation scale</p>
    <span>or</span>
    <button>Create a new elevation scale</button>
  </section>
  <!-- elevation settings -->
  <section data-section="elevationSettings">
    <p>Count: <input data-property="count" value="5"></p>
    <label><input type="checkbox" data-property="createStyles" />Create styles</label>
    <div id="elevationLayers"></div>
    <button id="add">Add Layer</button>
  </section>
</main>
<footer>
Help
</footer>

<template id="elevationLayerTemplate">
  <details class="shadow">
    <summary><input class="name" value="shadow"><button class="delete" data-action="deleteItem">ðŸ—‘</button></summary>
    <div>Type: 
      <select data-property="type">
        <option value="dropshadow">Dropshadow</option>
        <option value="innershadow">Innershadow</option>
      </select>
    </div>
    <p>X: <input data-property="x" value="0"></p>
    <p>Y: <input data-property="y" value="0"></p>
    <p>Blur: <input data-property="radius" value="0"></p>
    <p>Spread: <input data-property="spread" value="0"></p>
    <p>Color: <input data-property="color" value="#000000"></p>
    <p>Opacity: <input data-property="opacity" value="10"></p>
  </details>
</template>
<script> 
// selections
const elevationLayerTemplate = document.getElementById("elevationLayerTemplate")
const sectionElevationSettings = document.querySelector('[data-section="elevationSettings"]')
const sectionEmptyState = document.querySelector('[data-section="emptyState"]')
const list = document.getElementById("elevationLayers")
const count = document.querySelector('[data-property="count"]')
const createStyles = document.querySelector('[data-property="createStyles"]')
// events
onmessage = ({data = undefined}) => {
  if (data !== undefined && data.pluginMessage !== undefined) {
    const eventData = JSON.parse(data.pluginMessage)
    if (eventData.type === 'updateProperties') {
      updatePanel(eventData.properties)
    }
    // toggle state
    toggleEmptyState(eventData.type === 'emptyState')
  }
}

const updatePanel = data => {
  count.value = data.count
  createStyles.checked = (data.createStyles === true)
  data.elevationLayers.forEach(layer => {
    list.appendChild(createShadowLayer(layer))
  })
}

const toggleEmptyState = active => {
  if (active === true) {
    sectionEmptyState.classList.remove('hidden')
    sectionElevationSettings.classList.add('hidden')
  // hide emptyState 
  } else {
    sectionEmptyState.classList.add('hidden')
    sectionElevationSettings.classList.remove('hidden')   
  }
}

const getShadowLayerValues = shadowDetails => {
  const properties = [
    'type',
    'x',
    'y',
    'radius',
    'spread',
    'color',
    'opacity'
  ]

  let propertyValues = {}

  properties.forEach(property => {
    propertyValues[property] = shadowDetails.querySelector(`[data-property="${property}"]`).value
  })
  // return values
  return propertyValues
}

const saveShadows = (list) => {
  // get data for each shadow layer
  const elevationLayers = Array.from(list.querySelectorAll('details')).map(shadowDetails => getShadowLayerValues(shadowDetails))
  // send data
  parent.postMessage({ pluginMessage: 
    { 
      type: 'saveShadows',
      count: count.value,
      createStyles: createStyles.checked,
      elevationLayers
    } 
  }, '*')
}

// document.getElementById('create').onclick = () => {
//   saveShadows(list)
// }

const createShadowLayer = values => {
  // get clone
  const clone = elevationLayerTemplate.content.cloneNode(true)
  // replace values
  for (const key in values) {
    console.log(key)
    clone.querySelector(`[data-property="${key}"]`).value = values[key]
  }
  // return layer
  return clone
}

document.getElementById('add').onclick = () => {
  list.appendChild(createShadowLayer())
}

list.onclick = (e) => {
  if(e.target.dataset.action === 'deleteItem') {
    e.target.parentNode.parentNode.remove()
  }
}

// append new shadowLayer to list
// list.appendChild(createShadowLayer())

</script>

<!-- https://github.com/KaneCohen/tokenfield -->