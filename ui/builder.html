<h2>Rectangle Creator</h2>
<p>Count: <input data-property="count" value="5"></p>
<div id="shadows">

</div>
<button id="add">Add Shadow</button>

<div class="section">
  <label><input type="checkbox" data-property="createStyles" />Create styles</label>
</div>

<footer>
  <button id="create">Save</button>
  <button id="cancel">Cancel</button>
</footer>

<template id="shadowTemplate">
  <details class="shadow">
    <summary><input class="name" value="shadow"><button class="delete" data-action="deleteItem">ðŸ—‘</button></summary>
    <div>Type: 
      <select data-property="type">
        <option value="dropshadow">Dropshadow</option>
        <option value="innershadow">Innershadow</option>
      </select>
    </div>
    <p>X: <input data-property="x" value="0"></p>
    <p>Y: <input data-property="y" value="0"></p>
    <p>Blur: <input data-property="radius" value="0"></p>
    <p>Spread: <input data-property="spread" value="0"></p>
    <p>Color: <input data-property="color" value="#000000"></p>
    <p>Opacity: <input data-property="opacity" value="10"></p>
  </details>
</template>
<script> 
// selections
const template = document.getElementById("shadowTemplate")
const list = document.getElementById("shadows")
const count = document.querySelector('[data-property="count"]')
const createStyles = document.querySelector('[data-property="createStyles"]')
// events
onmessage = ({data = undefined}) => {
  if (data !== undefined && data.pluginMessage !== undefined) {
    const eventData = JSON.parse(data.pluginMessage)
    if (eventData.type === 'updateProperties') {
      updatePanel(eventData.properties)
    }
  }
}

const updatePanel = data => {
  count.value = data.count
  createStyles.checked = (data.createStyles === true)
  data.elevationLayers.forEach(layer => {
    list.appendChild(createShadowLayer(layer))
  })
}

const getShadowLayerValues = shadowDetails => {
  const properties = [
    'type',
    'x',
    'y',
    'radius',
    'spread',
    'color',
    'opacity'
  ]

  let propertyValues = {}

  properties.forEach(property => {
    propertyValues[property] = shadowDetails.querySelector(`[data-property="${property}"]`).value
  })
  // return values
  return propertyValues
}

const saveShadows = (list) => {
  // get data for each shadow layer
  const shadowLayers = Array.from(list.querySelectorAll('details')).map(shadowDetails => getShadowLayerValues(shadowDetails))
  // send data
  console.log('createStyles', createStyles.checked, createStyles.value)
  parent.postMessage({ pluginMessage: 
    { 
      type: 'saveShadows',
      count: count.value,
      createStyles: createStyles.checked,
      shadowLayers
    } 
  }, '*')
}

document.getElementById('create').onclick = () => {
  saveShadows(list)
}

document.getElementById('cancel').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*')
}

const createShadowLayer = values => {
  // get clone
  const clone = template.content.cloneNode(true)
  // replace values
  for (const key in values) {
    console.log(key)
    clone.querySelector(`[data-property="${key}"]`).value = values[key]
  }
  // return layer
  return clone
}

document.getElementById('add').onclick = () => {
  list.appendChild(createShadowLayer())
}

list.onclick = (e) => {
  if(e.target.dataset.action === 'deleteItem') {
    e.target.parentNode.parentNode.remove()
  }
}

// append new shadowLayer to list
// list.appendChild(createShadowLayer())

</script>

<!-- https://github.com/KaneCohen/tokenfield -->